#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import json
from os.path import isfile, join

# For each class, if the indexed talent tree has the most point, we should try using this model.
# I.E. Prot warr talent trees are Arms/Fury/Prot. So if more talent points are in tree 3, we should assume
# that the warrior is prot, and use the ProtWarr model in Rawr
MODELS = {
    'Warrior': {1: 'DPSWarr', 2: 'DPSWarr', 3: 'ProtWarr'},
    'DeathKnight': {1: 'TankDK', 2: 'DPSDK', 3: 'DPSDK'},
    'Druid': {2: 'Bear', 3: 'Tree', 1: 'Moonkin'},
    'Mage': {1: 'Mage', 2: 'Mage', 3: 'Mage'},
    'Warlock': {1: 'Warlock', 2: 'Warlock', 3: 'Warlock', },
    'Priest': {1: 'HealPriest', 2: 'HealPriest', 3: 'ShadowPriest'},
    'Hunter': {1: 'Hunter', 2: 'Hunter', 3: 'Hunter', },
    'Paladin': {1: 'Healadin', 2: 'ProtPaladin', 3: 'Retribution'},
    'Rogue': {1: 'Rogue', 2: 'Rogue', 3: 'Rogue', },
    'Shaman': {1: 'Elemental', 2: 'Enhance', 3: 'RestoSham'},
}

# EG doesn't give us race information, so we just guess a common race for each class.
DEFAULT_RACE = {
    'Warrior': 'Orc',
    'DeathKnight': 'Orc',
    'Druid': 'Tauren',
    'Mage': 'BloodElf',
    'Warlock': 'BloodElf',
    'Priest': 'Undead',
    'Hunter': 'Orc',
    'Paladin': 'BloodElf',
    'Rogue': 'Undead',
    'Shaman': 'Tauren',
}

# Rawr stores enchants that are available for the optimizer in a less than optimized way.
# Specifically, the format is a special 'enchant slot' index, followed by the enchantID of the enchant.
# The mapping for this enchant slot is as follows:
# -1: Head
# -3: Shoulder
# -4: Back
# -5: Chest
# -8: Wrist
# -9: Hands
# -11: Legs
# -12: Feet
# -15: MainHand
# -16: OffHand
# -18: Shield
# -19: Ranged
# So an enchant marked 'available' that is -153789 is enchantslot -15 and enchantID 3789.
# Specifically, a main hand berzerking enchant.
# Again, 1 maps to the first talent tree of the class, etc etc.
DEFAULT_ENCHANTS_AVAILABLE = {
    'Hunter': {
        1: [-53832, -13817, -33808, -41099, -83845, -93222, -113823, -163827, -153833, -193608, -123826,
            -122658, -120983, -123232, -121597],
        2: [-53832, -13817, -33808, -41099, -83845, -93222, -113823, -163827, -153833, -193608, -123826,
            -122658, -120983, -123232, -121597],
        3: [-53832, -13817, -33808, -41099, -83845, -93222, -113823, -163827, -153833, -193608, -123826,
            -122658, -120983, -123232, -121597],
    },
    'Warrior': {
        1: [-13817, -33808, -41099, -83845, -91603, -113823, -123826, -122658, -121597, -122939, -153789,
            -163789],
        2: [-13817, -33808, -41099, -83845, -91603, -113823, -123826, -122658, -121597, -122939, -153789,
            -163789],
        3: [-13818, -33811, -33852, -43294, -41951, -51953, -53297, -83850, -93330, -93253,
            -113822, -121075, -123232, -153869, -152673, -181952, -181071, -183849],
    },
    'DeathKnight': {
        1: [-13818, -33852, -153294, -151851, -53297, -93850, -103253, -73822, -83232, -163847],
        2: [-13817, -33808, -153831, -151099, -53832, -93845, -101603, -73823, -83232, -81597, -163370,
            -153368],
        3: [-13817, -33808, -153831, -151099, -53832, -93845, -101603, -73823, -83232, -81597, -163370,
            -153368],
    },
    'Druid': {
        1: [-13820, -33810, -43831, -53832, -82332, -93246, -113719, -123232, -153834, -153854],
        2: [-13817, -33808, -41099, -53832, -83845, -93222, -93234, -93231, -113823, -123826, -12983,
            -153789,
            -13818, -33852, -41099, -53832, -83850, -93222, -113822, -123232, -152673],
        3: [-13820, -33810, -43831, -53832, -82332, -93246, -113719, -123232, -121147, -153834, -153854],
    },
    'Mage': {
        1: [-13820, -33810, -43831, -53832, -82332, -93246, -113719, -123826, -123232, -153854, -153834,
            -153790],
        2: [-13820, -33810, -43831, -53832, -82332, -93246, -113719, -123826, -123232, -153854, -153834,
            -153790],
        3: [],
    },
    'Warlock': {
        1: [-13820, -33810, -43831, -53832, -82332, -93246, -113719, -123826, -123232, -153854, -153834,
            -153790],
        2: [-13820, -33810, -43831, -53832, -82332, -93246, -113719, -123826, -123232, -153854, -153834,
            -153790],
        3: [-13820, -33810, -43831, -53832, -82332, -93246, -113719, -123826, -123232, -153854, -153834,
            -153790],
    },
    'Priest': {
        1: [-13820, -33810, -43831, -53832, -82332, -93246, -113719, -123826, -123232, -153854, -153834,
            -53233, -13819, -33809],
        2: [-13820, -33810, -43831, -53832, -82332, -93246, -113719, -123826, -123232, -153854, -153834],
        3: [-13820, -33810, -43831, -53832, -82332, -93246, -113719, -123826, -123232, -153854, -153834],
    },
    'Paladin': {
        1: [-13820, -33810, -43831, -53832, -81119, -93246, -113719, -123826, -123232, -152666, -181128],
        2: [-13818, -33811, -43294, -41951, -51953, -51953, -53832, -53297, -83850, -93330, -93253, -113822,
            -123232, -121075, -153869, -152673, -181071, -181952],
        3: [-13817, -33808, -43831, -41099, -53832, -83845, -91603, -93234, -113823, -121597, -153789],
    },
    'Rogue': {
        1: [-13817, -33808, -43831, -53832, -83845, -91603, -113823, -123826, -153789, -163789],
        2: [-13817, -33808, -43831, -53832, -83845, -91603, -113823, -123826, -153789, -163789],
        3: [],
    },
    'Shaman': {
        1: [-13820, -33810, -43831, -53832, -82332, -93246, -113719, -123826, -123232, -153854, -153834,
            -153790, -181128],
        2: [-13817, -33808, -43831, -53832, -83845, -91603, -93234, -113823, -123826, -121597, -153789,
            -163789],
        3: [-13820, -33810, -43831, -53832, -82332, -93246, -113721, -123826, -123232, -153834, -152674,
            -181128],
    },
}

# The 'proper' wow mapping of ItemSlot to equip name.
EQUIP_MAP = {
    '1': 'Head',
    '2': 'Neck',
    '3': 'Shoulders',
    '4': 'Shirt',
    '5': 'Chest',
    '6': 'Waist',
    '7': 'Legs',
    '8': 'Feet',
    '9': 'Wrist',
    '10': 'Hands',
    '11': 'Finger1',
    '12': 'Finger2',
    '13': 'Trinket1',
    '14': 'Trinket2',
    '15': 'Back',
    '16': 'MainHand',
    '17': 'OffHand',
    '18': 'Ranged',
}

# EG stores gems as their enchantID effect, but Rawr uses the itemID. So we use this mapping to convert.
# It's generated by gems.py in the tools subfoler.
GEM_MAP = {
    '0': '0',
    '3292': '36766', '3371': '39900', '3374': '39905', '3376': '39907', '3377': '39908', '3378': '39909',
    '3379': '39910', '3380': '39911', '3446': '39996', '3447': '39997', '3448': '39998', '3449': '39999',
    '3450': '40000', '3451': '40001', '3452': '40002', '3453': '40003', '3518': '40111', '3519': '40112',
    '3520': '40113', '3521': '40114', '3522': '40115', '3523': '40116', '3525': '40117', '3524': '40118',
    '3649': '41432', '3644': '41434', '3648': '41435', '3652': '41436', '3647': '41437', '3650': '41438',
    '3646': '41439', '3732': '42142', '3733': '42143', '3734': '42144', '3740': '42151', '3741': '42152',
    '3745': '42153', '3746': '42154', '3861': '45862', '3862': '45879', '3866': '45883', '3293': '36767',
    '3387': '39919', '3388': '39920', '3389': '39927', '3390': '39932', '3454': '40008', '3455': '40009',
    '3456': '40010', '3457': '40011', '3532': '40119', '3533': '40120', '3534': '40121', '3535': '40122',
    '3654': '41440', '3655': '41441', '3653': '41442', '3656': '41443', '3735': '42145', '3736': '42146',
    '3747': '42155', '3863': '45880', '3864': '45881', '3427': '39968', '3428': '39974', '3429': '39975',
    '3430': '39976', '3431': '39977', '3432': '39978', '3433': '39979', '3434': '39980', '3435': '39981',
    '3436': '39982', '3437': '39983', '3438': '39984', '3439': '39985', '3440': '39986', '3441': '39988',
    '3442': '39989', '3443': '39990', '3444': '39991', '3445': '39992', '3499': '40085', '3500': '40086',
    '3501': '40088', '3502': '40089', '3503': '40090', '3504': '40091', '3505': '40092', '3510': '40094',
    '3506': '40095', '3511': '40096', '3515': '40098', '3507': '40099', '3512': '40100', '3516': '40101',
    '3508': '40102', '3513': '40103', '3509': '40104', '3514': '40105', '3517': '40106', '3572': '40164',
    '3573': '40165', '3574': '40166', '3575': '40167', '3576': '40168', '3577': '40169', '3578': '40170',
    '3579': '40171', '3580': '40172', '3581': '40173', '3582': '40174', '3583': '40175', '3584': '40176',
    '3585': '40177', '3586': '40178', '3587': '40179', '3588': '40180', '3589': '40181', '3590': '40182',
    '3711': '41463', '3700': '41464', '3714': '41465', '3702': '41466', '3701': '41467', '3699': '41468',
    '3712': '41469', '3698': '41470', '3713': '41471', '3709': '41472', '3705': '41473', '3716': '41474',
    '3703': '41475', '3708': '41476', '3710': '41477', '3715': '41478', '3706': '41479', '3707': '41480',
    '3704': '41481', '3274': '35501', '3621': '41285', '3622': '41307', '3623': '41333', '3624': '41335',
    '3625': '41339', '3632': '41375', '3633': '41376', '3634': '41377', '3635': '41378', '3636': '41379',
    '3637': '41380', '3638': '41381', '3639': '41382', '3640': '41385', '3641': '41389', '3626': '41395',
    '3631': '41396', '3642': '41397', '3628': '41398', '3643': '41400', '3627': '41401', '3798': '44076',
    '3799': '44078', '3801': '44081', '3800': '44082', '3802': '44084', '3803': '44087', '3804': '44088',
    '3805': '44089', '3404': '39946', '3405': '39947', '3411': '39948', '3407': '39949', '3408': '39950',
    '3409': '39951', '3410': '39952', '3406': '39953', '3412': '39954', '3413': '39955', '3414': '39956',
    '3415': '39957', '3416': '39958', '3417': '39959', '3422': '39960', '3423': '39961', '3424': '39962',
    '3426': '39963', '3418': '39964', '3419': '39965', '3420': '39966', '3421': '39967', '3477': '40037',
    '3478': '40038', '3479': '40039', '3480': '40040', '3481': '40041', '3482': '40043', '3483': '40044',
    '3484': '40045', '3485': '40046', '3486': '40047', '3487': '40048', '3488': '40049', '3489': '40050',
    '3490': '40051', '3491': '40052', '3492': '40053', '3493': '40054', '3494': '40055', '3495': '40056',
    '3496': '40057', '3497': '40058', '3498': '40059', '3549': '40142', '3550': '40143', '3551': '40144',
    '3552': '40145', '3553': '40146', '3554': '40147', '3555': '40148', '3556': '40149', '3557': '40150',
    '3558': '40151', '3559': '40152', '3560': '40153', '3561': '40154', '3563': '40155', '3564': '40156',
    '3565': '40157', '3566': '40158', '3567': '40159', '3568': '40160', '3569': '40161', '3570': '40162',
    '3571': '40163', '3767': '41429', '3696': '41482', '3683': '41483', '3686': '41484', '3677': '41485',
    '3692': '41486', '3680': '41487', '3682': '41488', '3685': '41489', '3695': '41490', '3687': '41491',
    '3681': '41492', '3688': '41493', '3689': '41494', '3690': '41495', '3679': '41496', '3693': '41497',
    '3697': '41498', '3684': '41499', '3694': '41500', '3678': '41501', '3691': '41502', '3242': '34142',
    '3254': '34143', '3749': '42701', '3750': '42702', '3879': '49110', '3391': '39933', '3392': '39934',
    '3393': '39935', '3394': '39936', '3395': '39937', '3396': '39938', '3397': '39939', '3398': '39940',
    '3399': '39941', '3400': '39942', '3401': '39943', '3402': '39944', '3403': '39945', '3464': '40022',
    '3465': '40023', '3474': '40024', '3466': '40025', '3472': '40026', '3473': '40027', '3476': '40028',
    '3467': '40029', '3475': '40030', '3468': '40031', '3469': '40032', '3470': '40033', '3471': '40034',
    '3536': '40129', '3537': '40130', '3544': '40131', '3538': '40132', '3545': '40133', '3546': '40134',
    '3548': '40135', '3539': '40136', '3547': '40137', '3540': '40138', '3541': '40139', '3543': '40140',
    '3542': '40141', '3664': '41450', '3670': '41451', '3675': '41452', '3669': '41453', '3663': '41454',
    '3674': '41455', '3665': '41456', '3673': '41457', '3668': '41458', '3672': '41459', '3667': '41460',
    '3671': '41461', '3666': '41462', '3381': '39912', '3382': '39914', '3383': '39915', '3384': '39916',
    '3385': '39917', '3386': '39918', '3458': '40012', '3459': '40013', '3460': '40014', '3461': '40015',
    '3462': '40016', '3463': '40017', '3526': '40123', '3527': '40124', '3528': '40125', '3529': '40126',
    '3530': '40127', '3531': '40128', '3661': '41444', '3662': '41445', '3659': '41446', '3660': '41447',
    '3657': '41448', '3658': '41449', '3737': '42148', '3738': '42149', '3739': '42150', '3742': '42156',
    '3743': '42157', '3744': '42158', '3792': '44066', '3865': '45882', '3867': '45987'
}


def get_eg_file(install_path, username):
    return join(install_path, "WTF/Account", username.upper(), "SavedVariables/ElitistGroup.lua")


def get_eg_data():
    if isfile('.wowpath'):
        with open('.wowpath') as f:
            wow_path = f.read()
    else:
        while True:
            print("Please give the path to your WoW install:")
            install_path = input()
            print("Please give the account username that has the EG files:")
            username = input()
            wow_path = get_eg_file(install_path, username)
            if isfile(wow_path):
                with open('.wowpath', 'w') as f:
                    f.write(wow_path)
                break

    with open(wow_path) as f:
        EG_data = f.read()
    return EG_data


def egdata_to_json(data):
    # This is pretty hacky, but EG doesn't store data as a lua table, or json, or really anything of use.
    # So I'm just kludging it into something approaching json here.
    data = data.replace(';', ', ').replace('["', '"').replace('"]', '"')
    data = data.replace('[', '"').replace(']', '"').replace('=', ':')
    for rep in ['notes', 'secondarySpec', 'achievements', 'classToken', 'talentTree3', 'scanned', 'equipment',
                'talentTree1', 'name', 'from', 'level', 'talentTree2', 'server', 'rating', 'time', 'role',
                'pruned', 'true', 'specRole', 'comment', 'mainAchievements', 'unspentPoints']:
        data = data.replace(rep, f'"{rep}"')
    data = data.replace(', }', '}')
    data = data.replace(', ', ',\n')
    return json.loads(data)
